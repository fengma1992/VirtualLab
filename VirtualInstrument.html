<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no"/>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/draggable.css">
    <link rel="stylesheet" href="css/popup.css"/>
    <title>虚拟仪器实验</title>
</head>
<body onload="init()">
<div id="container-div" class="rowFlexDiv">
    <div id="sideBar" class="draggable-sideBar">
        <canvas id="WaveVI-canvas" class="draggable-element" width="162" height="90"
                zoom="3"
                draggable="true"
                ondragstart="drag(event)">
        </canvas>
        <canvas id="BallBeamVI-canvas" class="draggable-element" width="162" height="90"
                zoom="4"
                draggable="true"
                ondragstart="drag(event)">
        </canvas>
        <canvas id="TextVI-canvas" class="draggable-element" width="104" height="45"
                ondblclick="showBox(this)"
                zoom="1"
                draggable="true"
                ondragstart="drag(event)">
        </canvas>
        <canvas id="KnobVI-canvas" class="draggable-element" width="45" height="45"
                ondblclick="showBox(this)"
                zoom="3"
                draggable="true"
                ondragstart="drag(event)">
        </canvas>
        <canvas id="AddVI-canvas" class="draggable-element" width="45" height="45"
                ondblclick="showBox(this)"
                zoom="1"
                draggable="true"
                ondragstart="drag(event)">
        </canvas>
        <canvas id="DCOutputVI-canvas" class="draggable-element" width="45" height="45"
                ondblclick="showBox(this)"
                zoom="1"
                draggable="true"
                ondragstart="drag(event)">
        </canvas>
        <canvas id="PIDVI-canvas" class="draggable-element" width="45" height="45"
                ondblclick="showBox(this)"
                zoom="1"
                draggable="true"
                ondragstart="drag(event)">
        </canvas>
        <canvas id="RelayVI-canvas" class="draggable-element" width="45" height="45"
                ondblclick=""
                zoom="1"
                draggable="true"
                ondragstart="drag(event)">
        </canvas>
        <canvas id="ProportionalResponseVI-canvas" class="draggable-element" width="45" height="45"
                ondblclick="showBox(this)"
                zoom="1"
                draggable="true"
                ondragstart="drag(event)">
        </canvas>
        <canvas id="IntegralResponseVI-canvas" class="draggable-element" width="45" height="45"
                ondblclick="showBox(this)"
                zoom="1"
                draggable="true"
                ondragstart="drag(event)">
        </canvas>
        <canvas id="DifferentialResponseVI-canvas" class="draggable-element" width="45" height="45"
                ondblclick="showBox(this)"
                zoom="1"
                draggable="true"
                ondragstart="drag(event)">
        </canvas>
        <canvas id="InertiaResponseVI-canvas" class="draggable-element" width="45" height="45"
                ondblclick="showBox(this)"
                zoom="1"
                draggable="true"
                ondragstart="drag(event)">
        </canvas>
        <canvas id="OscillationResponseVI-canvas" class="draggable-element" width="45" height="45"
                ondblclick="showBox(this)"
                zoom="1"
                draggable="true"
                ondragstart="drag(event)">
        </canvas>
        <canvas id="ProportionalIntegralResponseVI-canvas" class="draggable-element" width="45" height="45"
                ondblclick="showBox(this)"
                zoom="1"
                draggable="true"
                ondragstart="drag(event)">
        </canvas>
        <canvas id="ProportionalDifferentialResponseVI-canvas" class="draggable-element" width="45" height="45"
                ondblclick="showBox(this)"
                zoom="1"
                draggable="true"
                ondragstart="drag(event)">
        </canvas>
        <canvas id="ProportionalInertiaResponseVI-canvas" class="draggable-element" width="45" height="45"
                ondblclick="showBox(this)"
                zoom="1"
                draggable="true"
                ondragstart="drag(event)">
        </canvas>
        <canvas id="SignalGeneratorVI-canvas" class="draggable-element" width="45" height="45"
                ondblclick="showBox(this)"
                zoom="1"
                draggable="true"
                ondragstart="drag(event)">
        </canvas>
    </div>
    <div id="container" class="draggable-div" ondrop="drop(event)" ondragover="allowDrop(event)">
    </div>
</div>
<!--虚拟仪器库-->
<script src="js/VILibraries/AddVI.js"></script>
<script src="js/VILibraries/BallBeamVI.js"></script>
<script src="js/VILibraries/DCOutputVI.js"></script>
<script src="js/VILibraries/KnobVI.js"></script>
<script src="js/VILibraries/PIDVI.js"></script>
<script src="js/VILibraries/RelayVI.js"></script>
<script src="js/VILibraries/SignalGeneratorVI.js"></script>
<script src="js/VILibraries/TextVI.js"></script>
<script src="js/VILibraries/WaveVI.js"></script>
<!--*************阶跃响应************************-->
<script src="js/VILibraries/DifferentialResponseVI.js"></script>
<script src="js/VILibraries/InertiaResponseVI.js"></script>
<script src="js/VILibraries/IntegralResponseVI.js"></script>
<script src="js/VILibraries/OscillationResponseVI.js"></script>
<script src="js/VILibraries/ProportionalDifferentialResponseVI.js"></script>
<script src="js/VILibraries/ProportionalInertiaResponseVI.js"></script>
<script src="js/VILibraries/ProportionalIntegralResponseVI.js"></script>
<script src="js/VILibraries/ProportionalResponseVI.js"></script>
<!--********************************************-->
<!--三维显示库-->
<script src="js/three.js"></script>
<script src="js/MTLLoader.js"></script>
<script src="js/OBJLoader.js"></script>
<script src="js/controls/OrbitControls.js"></script>
<script src="js/ObjectControls.js"></script>
<!--拖拽连线库-->
<script src="js/jsPlumb-2.2.2.js"></script>
<!--弹出框-->
<script src="js/popup.js"></script>
<script>

    var sideBar = document.getElementById('sideBar');
    var VIContainer = document.getElementById('container');

    var instance;
    var dataSetBox = [], inputSetBox = [], outputSetBox = [];
    var dataObject = {
        THREECount: 0,
        BallBeamVICount: 0,
        WaveVICount: 0,
        AddVICount: 0,
        DCOutputVICount: 0,
        KnobVICount: 0,
        PIDVICount: 0,
        RelayVICount: 0,
        TextVICount: 0,
        ProportionalResponseVICount: 0,
        IntegralResponseVICount: 0,
        DifferentialResponseVICount: 0,
        InertiaResponseVICount: 0,
        OscillationResponseVICount: 0,
        ProportionalIntegralResponseVICount: 0,
        ProportionalDifferentialResponseVICount: 0,
        ProportionalInertiaResponseVICount: 0,
        SignalGeneratorVICount: 0,
        THREE: [],
        BallBeamVI: [],
        WaveVI: [],
        AddVI: [],
        DCOutputVI: [],
        KnobVI: [],
        PIDVI: [],
        RelayVI: [],
        TextVI: [],
        ProportionalResponseVI: [],
        IntegralResponseVI: [],
        DifferentialResponseVI: [],
        InertiaResponseVI: [],
        OscillationResponseVI: [],
        ProportionalIntegralResponseVI: [],
        ProportionalDifferentialResponseVI: [],
        ProportionalInertiaResponseVI: [],
        SignalGeneratorVI: []
    };

    function init() {
        new AddVI(document.getElementById('AddVI-canvas'));
        new BallBeamVI(document.getElementById('BallBeamVI-canvas'));
        new DCOutputVI(document.getElementById('DCOutputVI-canvas'));
        new KnobVI(document.getElementById('KnobVI-canvas'));
        new PIDVI(document.getElementById('PIDVI-canvas'));
        new RelayVI(document.getElementById('RelayVI-canvas'));
        new SignalGeneratorVI(document.getElementById('SignalGeneratorVI-canvas'));
        new TextVI(document.getElementById('TextVI-canvas'));
        new WaveVI(document.getElementById('WaveVI-canvas'));
        new ProportionalResponseVI(document.getElementById('ProportionalResponseVI-canvas'));
        new IntegralResponseVI(document.getElementById('IntegralResponseVI-canvas'));
        new DifferentialResponseVI(document.getElementById('DifferentialResponseVI-canvas'));
        new InertiaResponseVI(document.getElementById('InertiaResponseVI-canvas'));
        new OscillationResponseVI(document.getElementById('OscillationResponseVI-canvas'));
        new ProportionalIntegralResponseVI(document.getElementById('ProportionalIntegralResponseVI-canvas'));
        new ProportionalDifferentialResponseVI(document.getElementById('ProportionalDifferentialResponseVI-canvas'));
        new ProportionalInertiaResponseVI(document.getElementById('ProportionalInertiaResponseVI-canvas'));
        ready();
        resize();
    }

    function ready() {

        instance = window.jsp = jsPlumb.getInstance({
            // default drag options
            DragOptions: {cursor: 'pointer', zIndex: 2000},
            // the overlays to decorate each connection with.  note that the label overlay uses a function to generate the label text;
            // in this case it returns the 'labelText' member that we set on each connection in the 'init' method below.
            ConnectionOverlays: [
                ['Arrow', {
                    location: 1,
                    visible: true,
                    width: 11,
                    length: 11,
                    id: 'ARROW',
                    events: {
                        click: function () {
//                            alert('you clicked on the arrow overlay')
                            //点击箭头事件
                        }
                    }
                }]
            ],
            Container: 'container'
        });

        var basicType = {
            connector: 'StateMachine',
            paintStyle: {stroke: 'red', strokeWidth: 4},
            hoverPaintStyle: {stroke: 'blue'},
            overlays: ['Arrow']
        };

        instance.registerConnectionType('basic', basicType);

        // suspend drawing and initialise.
        instance.batch(function () {

            // 监听连线事件
            instance.bind('connection', function (connectionInfo) {

                var sourceArr = connectionInfo.connection.sourceId.split('-');
                var targetArr = connectionInfo.connection.targetId.split('-');
                var sourceElement = getObjectVIByName(sourceArr[0])[sourceArr[2]];
                var targetElement = getObjectVIByName(targetArr[0])[targetArr[2]];

                //对多输出控件判断
                if (sourceElement.name == 'BallBeamVI') {

                    outputSetBox[0] = true;
                    outputSetBox[1] = G.box('请选择' + sourceElement.cnText + '输出参数&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
                            '<div class="input-div">' +
                            '<input type="radio" class="radioInput" name="output-type" value="1" onclick="outputSetBox[1].close()">反馈角度(单值)<br>' +
                            '<input type="radio" class="radioInput" name="output-type" value="2" onclick="outputSetBox[1].close()">反馈位置(单值)<br>' +
                            '<input type="radio" class="radioInput" name="output-type" value="3" onclick="outputSetBox[1].close()">反馈角度(数组)<br>' +
                            '<input type="radio" class="radioInput" name="output-type" value="4" onclick="outputSetBox[1].close()">反馈位置(数组)<br>' +
                            '<input type="radio" class="radioInput" name="output-type" value="5" onclick="outputSetBox[1].close()">标记位置(单值)<br>' +
                            '</div>',
                            1, function () {

                                outputSetBox[0] = false;
                                var outputType = document.getElementsByName('output-type');
                                var checkedValue = -1;
                                for (var i = 0; i < outputType.length; i++) {

                                    if (outputType[i].checked == true) {

                                        checkedValue = outputType[i].value;
                                        break;
                                    }
                                }
                                if (checkedValue == -1) {

                                    if (connectionInfo) {

                                        instance.detach(connectionInfo.connection);
                                        connectionInfo = null;
                                    }
                                    closeBox();
                                    G.alert('未选择' + sourceElement.cnText + '输出参数！', 1, 1500);
                                    return;
                                }

                                sourceElement.target.push([targetElement, checkedValue]);
                            });
                }
                else if (sourceElement.outputCount == 2) {

                    outputSetBox[0] = true;
                    outputSetBox[1] = G.box('请选择' + sourceElement.cnText + '输出参数&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
                            '<div class="input-div">' +
                            '<input type="radio" class="radioInput" name="output-type" value="1" onclick="outputSetBox[1].close()">输出(单值)<br>' +
                            '<input type="radio" class="radioInput" name="output-type" value="2" onclick="outputSetBox[1].close()">输出(数组)<br>' +
                            '</div>',
                            1, function () {

                                outputSetBox[0] = false;
                                var outputType = document.getElementsByName('output-type');
                                var checkedValue = -1;
                                for (var i = 0; i < outputType.length; i++) {

                                    if (outputType[i].checked == true) {

                                        checkedValue = outputType[i].value;
                                        break;
                                    }
                                }
                                if (checkedValue == -1) {

                                    if (connectionInfo != null && connectionInfo != undefined) {

                                        instance.detach(connectionInfo.connection);
                                        connectionInfo = null;
                                    }
                                    closeBox();
                                    G.alert('未选择' + sourceElement.cnText + '输出参数！', 1, 1500);
                                    return;
                                }

                                sourceElement.target.push([targetElement, checkedValue]);
                            });
                }
                else {

                    sourceElement.target.push([targetElement, 1]);  //单输出时默认输出单值
                }

                //对于多输入控件,进行输入端口判断
                if (targetElement.name == 'AddVI') {

                    inputSetBox[0] = true;
                    inputSetBox[1] = G.box('请选择' + targetElement.cnText + '输入参数&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
                            '<div class="input-div">' +
                            '<input type="radio" class="radioInput" name="AddVI-type" value="1" alt="初值" onclick="inputSetBox[1].close()">初值<br>' +
                            '<input type="radio" class="radioInput" name="AddVI-type" value="2" alt="反馈值" onclick="inputSetBox[1].close()">反馈值<br>' +
                            '</div>',
                            1, function () {

                                inputSetBox[0] = false;
                                var inputType = document.getElementsByName('AddVI-type');
                                var checkedValue = -1, i;
                                for (i = 0; i < inputType.length; i++) {

                                    if (inputType[i].checked == true) {

                                        checkedValue = inputType[i].value;
                                        break;
                                    }
                                }
                                if (checkedValue == -1) {

                                    if (connectionInfo) {

                                        instance.detach(connectionInfo.connection);
                                        connectionInfo = null;
                                    }
                                    closeBox();
                                    G.alert('未选择' + targetElement.cnText + '输入参数！', 1, 1500);
                                    return;
                                }
                                var name = checkIfTargetValueBound(targetElement, checkedValue);    //检测此输入端口是否已与其他VI连接
                                if (name) {

                                    if (connectionInfo) {

                                        instance.detach(connectionInfo.connection);
                                        connectionInfo = null;
                                    }
                                    closeBox();
                                    G.alert(targetElement.cnText + inputType[i].alt + '已与' + name + '绑定！', 1, 1500);
                                    return;
                                }
                                targetElement.source.push([sourceElement, checkedValue]);
                            }
                    );
                }
                else if (targetElement.name == 'SignalGeneratorVI') {

                    inputSetBox[0] = true;
                    inputSetBox[1] = G.box('请选择' + targetElement.cnText + '输入参数&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
                            '<div class="input-div">' +
                            '<input type="radio" class="radioInput" name="SignalGeneratorVI-type" value="1" alt="幅值" onclick="inputSetBox[1].close()">幅值<br>' +
                            '<input type="radio" class="radioInput" name="SignalGeneratorVI-type" value="2" alt="频率" onclick="inputSetBox[1].close()">频率<br>' +
                            '</div>',
                            1, function () {

                                inputSetBox[0] = false;
                                var inputType = document.getElementsByName('SignalGeneratorVI-type');
                                var checkedValue = -1, i;
                                for (i = 0; i < inputType.length; i++) {

                                    if (inputType[i].checked == true) {

                                        checkedValue = inputType[i].value;
                                    }
                                }
                                if (checkedValue == -1) {

                                    if (connectionInfo) {

                                        instance.detach(connectionInfo.connection);
                                        connectionInfo = null;
                                    }
                                    closeBox();
                                    G.alert('未选择' + targetElement.cnText + '输入参数！', 1, 1500);
                                    return;
                                }
                                var name = checkIfTargetValueBound(targetElement, checkedValue);    //检测此输入端口是否已与其他VI连接
                                if (name) {

                                    if (connectionInfo) {

                                        instance.detach(connectionInfo.connection);
                                        connectionInfo = null;
                                    }
                                    closeBox();
                                    G.alert(targetElement.cnText + inputType[i].alt + '已与' + name + '绑定！', 1, 1500);
                                    return;
                                }
                                targetElement.source.push([sourceElement, checkedValue]);
                            }
                    );
                }
                else {

                    targetElement.source[0] = [sourceElement, 0];
                    if (targetElement.name == 'BallBeamVI') {

                        window.setInterval(function () {
                            checkIfThreeDVIStarted(targetElement)
                        }, 1000);
                    }
                }
            });

            // 绑定点击删除连线
            instance.bind('click', function (conn) {
                        G.confirm("删除连接?", function (z) {
                            if (z) {

                                instance.detach(conn);
                            }
                        }, 1);
                    }
            );

            //监听断开连线事件
            instance.bind('connectionDetached', function (connectionInfo) {

                var sourceArr = connectionInfo.connection.sourceId.split('-');
                var targetArr = connectionInfo.connection.targetId.split('-');
                var sourceElement = getObjectVIByName(sourceArr[0])[sourceArr[2]];
                var targetElement = getObjectVIByName(targetArr[0])[targetArr[2]];

                var i;
                for (i = 0; i < sourceElement.target.length; i++) {

                    if (sourceElement.target[i][0] == targetElement) {

                        sourceElement.target.splice(i, 1);
                        break;
                    }
                }
                for (i = 0; i < targetElement.source.length; i++) {

                    if (targetElement.source[i][0] == sourceElement) {

                        targetElement.source.splice(i, 1);
                        break;
                    }
                }
            });
        });

        jsPlumb.fire('jsPlumbDemoLoaded', instance);

    }

    function checkIfTargetValueBound(targetElement, checkedValue) {

        var i;
        for (i = 0; i < targetElement.source.length; i++) {

            if (targetElement.source[i][1] == checkedValue) {
                return targetElement.source[i][0].cnText;
            }
        }
        return false;
    }

    function getObjectVIByName(name) {

        switch (name) {

            case 'BallBeamVI':
                return dataObject.BallBeamVI;

            case 'WaveVI':
                return dataObject.WaveVI;

            case 'DCOutputVI':
                return dataObject.DCOutputVI;

            case 'KnobVI':
                return dataObject.KnobVI;

            case 'PIDVI':
                return dataObject.PIDVI;

            case 'RelayVI':
                return dataObject.RelayVI;

            case 'TextVI':
                return dataObject.TextVI;

            case 'AddVI':
                return dataObject.AddVI;

            case 'ProportionalResponseVI':
                return dataObject.ProportionalResponseVI;

            case 'IntegralResponseVI':
                return dataObject.IntegralResponseVI;

            case 'DifferentialResponseVI':
                return dataObject.DifferentialResponseVI;

            case 'InertiaResponseVI':
                return dataObject.InertiaResponseVI;

            case 'OscillationResponseVI':
                return dataObject.OscillationResponseVI;

            case 'ProportionalIntegralResponseVI':
                return dataObject.ProportionalIntegralResponseVI;

            case 'ProportionalDifferentialResponseVI':
                return dataObject.ProportionalDifferentialResponseVI;

            case 'ProportionalInertiaResponseVI':
                return dataObject.ProportionalInertiaResponseVI;

            case 'SignalGeneratorVI':
                return dataObject.SignalGeneratorVI;
        }
    }

    function showBox(element) {

        var elementInfo = element.id.split('-');
        switch (elementInfo[0]) {

            case 'AddVI':

                dataSetBox[0] = true;
                dataSetBox[1] = G.box('请输入初始值&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
                        '<div class="input-div">' +
                        '<span class="normalSpan">初值:</span><input type="number" id="AddVI-input" value="20" class="normalInput">' +
                        '<button id="startBtn" class="normalBtn" onclick="setAddVI(' + elementInfo[2] + ')">确定</button>' +
                        '</div>', 1, function () {
                            dataSetBox[0] = false;
                        });
                break;

            case 'PIDVI':

                dataSetBox[0] = true;
                dataSetBox[1] = G.box('请输入PID参数&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
                        '<div class="input-div">' +
                        '<span class="normalSpan">P:</span><input type="number" id="PIDVI-input-1" value="20" class="normalInput">' +
                        '<span class="normalSpan">I:</span><input type="number" id="PIDVI-input-2" value="0" class="normalInput">' +
                        '<span class="normalSpan">D:</span><input type="number" id="PIDVI-input-3" value="20" class="normalInput">' +
                        '<button id="startBtn" class="normalBtn" onclick="setPIDVI(' + elementInfo[2] + ')">确定</button>' +
                        '</div>', 1, function () {
                            dataSetBox[0] = false;
                        });
                break;

            case 'TextVI':

                dataSetBox[0] = true;
                dataSetBox[1] = G.box('请输入保留小数位数&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
                        '<div class="input-div">' +
                        '<input type="number" id="TextVI-input" value="1" class="normalInput">' +
                        '<button id="startBtn" class="normalBtn" onclick="setTextVI(' + elementInfo[2] + ')">确定</button>' +
                        '</div>', 1, function () {
                            dataSetBox[0] = false;
                        });
                break;

            case 'DCOutputVI':

                dataSetBox[0] = true;
                dataSetBox[1] = G.box('请设置输出值&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
                        '<div class="input-div">' +
                        '<span class="normalSpan">初值:</span><input type="number" id="DCOutputVI-input" value="100" class="normalInput">' +
                        '<button id="startBtn" class="normalBtn" onclick="setDCOutputVI(' + elementInfo[2] + ')">确定</button>' +
                        '</div>', 1, function () {
                            dataSetBox[0] = false;
                        });
                break;

            case 'KnobVI':

                dataSetBox[0] = true;
                dataSetBox[1] = G.box('请输入初始值&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
                        '<div class="input-div">' +
                        '<span class="normalSpan">最小值:</span><input type="number" id="KnobVI-input-1" value="0" class="normalInput">' +
                        '<span class="normalSpan">最大值:</span><input type="number" id="KnobVI-input-2" value="100" class="normalInput">' +
                        '<span class="normalSpan">初值:</span><input type="number" id="KnobVI-input-3" value="100" class="normalInput">' +
                        '<button id="startBtn" class="normalBtn" onclick="setKnobVI(' + elementInfo[2] + ')">确定</button>' +
                        '</div>', 1, function () {
                            dataSetBox[0] = false;
                        });
                break;

            case 'ProportionalResponseVI':

                dataSetBox[0] = true;
                dataSetBox[1] = G.box('比例响应&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
                        '<div class="input-div">' +
                        '<span class="normalSpan">K1:</span><input type="number" id="ProportionalResponseVI-input" value="1.5" class="normalInput">' +
                        '<button id="startBtn" class="normalBtn" onclick="setProportionalResponseVI(' + elementInfo[2] + ')">确定</button>' +
                        '</div>', 1, function () {
                            dataSetBox[0] = false;
                        });
                break;

            case 'IntegralResponseVI':

                dataSetBox[0] = true;
                dataSetBox[1] = G.box('积分响应&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
                        '<div class="input-div">' +
                        '<span class="normalSpan">K2:</span><input type="number" id="IntegralResponseVI-input" value="5" class="normalInput">' +
                        '<button id="startBtn" class="normalBtn" onclick="setIntegralResponseVI(' + elementInfo[2] + ')">确定</button>' +
                        '</div>', 1, function () {
                            dataSetBox[0] = false;
                        });
                break;

            case 'DifferentialResponseVI':

                dataSetBox[0] = true;
                dataSetBox[1] = G.box('微分响应&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
                        '<div class="input-div">' +
                        '<span class="normalSpan">K3:</span><input type="number" id="DifferentialResponseVI-input" value="0.0025" class="normalInput">' +
                        '<button id="startBtn" class="normalBtn" onclick="setDifferentialResponseVI(' + elementInfo[2] + ')">确定</button>' +
                        '</div>', 1, function () {
                            dataSetBox[0] = false;
                        });
                break;

            case 'InertiaResponseVI':

                dataSetBox[0] = true;
                dataSetBox[1] = G.box('惯性响应&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
                        '<div class="input-div">' +
                        '<span class="normalSpan">K:</span><input type="number" id="InertiaResponseVI-input" value="0.025" class="normalInput">' +
                        '<button id="startBtn" class="normalBtn" onclick="setInertiaResponseVI(' + elementInfo[2] + ')">确定</button>' +
                        '</div>', 1, function () {
                            dataSetBox[0] = false;
                        });
                break;

            case 'OscillationResponseVI':

                dataSetBox[0] = true;
                dataSetBox[1] = G.box('震荡响应&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
                        '<div class="input-div">' +
                        '<span class="normalSpan">K1:</span><input type="number" id="OscillationResponseVI-input-1" value="50" class="normalInput">' +
                        '<span class="normalSpan">K2:</span><input type="number" id="OscillationResponseVI-input-2" value="0.05" class="normalInput">' +
                        '<button id="startBtn" class="normalBtn" onclick="setOscillationResponseVI(' + elementInfo[2] + ')">确定</button>' +
                        '</div>', 1, function () {
                            dataSetBox[0] = false;
                        });
                break;

            case 'ProportionalIntegralResponseVI':

                dataSetBox[0] = true;
                dataSetBox[1] = G.box('比例积分响应&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
                        '<div class="input-div">' +
                        '<span class="normalSpan">K1:</span><input type="number" id="ProportionalIntegralResponseVI-input-1" value="1" class="normalInput">' +
                        '<span class="normalSpan">K2:</span><input type="number" id="ProportionalIntegralResponseVI-input-2" value="1" class="normalInput">' +
                        '<button id="startBtn" class="normalBtn" onclick="setProportionalIntegralResponseVI(' + elementInfo[2] + ')">确定</button>' +
                        '</div>', 1, function () {
                            dataSetBox[0] = false;
                        });
                break;

            case 'ProportionalDifferentialResponseVI':

                dataSetBox[0] = true;
                dataSetBox[1] = G.box('比例微分响应&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
                        '<div class="input-div">' +
                        '<span class="normalSpan">K1:</span><input type="number" id="ProportionalDifferentialResponseVI-input-1" value="1" class="normalInput">' +
                        '<span class="normalSpan">K3:</span><input type="number" id="ProportionalDifferentialResponseVI-input-2" value="1" class="normalInput">' +
                        '<button id="startBtn" class="normalBtn" onclick="setProportionalDifferentialResponseVI(' + elementInfo[2] + ')">确定</button>' +
                        '</div>', 1, function () {
                            dataSetBox[0] = false;
                        });
                break;

            case 'ProportionalInertiaResponseVI':

                dataSetBox[0] = true;
                dataSetBox[1] = G.box('比例惯性响应&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
                        '<div class="input-div">' +
                        '<span class="normalSpan">K1:</span><input type="number" id="ProportionalInertiaResponseVI-input-1" value="1" class="normalInput">' +
                        '<span class="normalSpan">K2:</span><input type="number" id="ProportionalInertiaResponseVI-input-2" value="1" class="normalInput">' +
                        '<button id="startBtn" class="normalBtn" onclick="setProportionalInertiaResponseVI(' + elementInfo[2] + ')">确定</button>' +
                        '</div>', 1, function () {
                            dataSetBox[0] = false;
                        });
                break;

            case 'SignalGeneratorVI':

                dataSetBox[0] = true;
                dataSetBox[1] = G.box('请选择信号类型&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
                        '<div class="input-div">' +
                        '<input type="radio" class="radioInput" name="SignalGeneratorVI-type" value="1" onclick="setSignalGeneratorVI(' + elementInfo[2] + ',this.value)">正弦波<br>' +
                        '<input type="radio" class="radioInput" name="SignalGeneratorVI-type" value="2" onclick="setSignalGeneratorVI(' + elementInfo[2] + ',this.value)">方波<br>' +
                        '<input type="radio" class="radioInput" name="SignalGeneratorVI-type" value="3" onclick="setSignalGeneratorVI(' + elementInfo[2] + ',this.value)">三角波<br>' +
                        '<input type="radio" class="radioInput" name="SignalGeneratorVI-type" value="4" onclick="setSignalGeneratorVI(' + elementInfo[2] + ',this.value)">白噪声<br>' +
                        '</div>', 1, function () {
                            dataSetBox[0] = false;
                        });
                break;
        }
    }

    function closeBox() {
        if (dataSetBox[0]) {
            dataSetBox[1].close();
        }
        if (inputSetBox[0]) {
            inputSetBox[1].close();
        }
        if (outputSetBox[0]) {
            outputSetBox[1].close();
        }
    }

    function setAddVI(elementNumber) {

        closeBox();

        dataObject.AddVI[elementNumber].setOriginalData(document.getElementById('AddVI-input').value);

        findTimerExecutor(dataObject.AddVI[elementNumber]);
    }

    function setPIDVI(elementNumber) {

        closeBox();
        dataObject.PIDVI[elementNumber].P = document.getElementById('PIDVI-input-1').value;
        dataObject.PIDVI[elementNumber].I = document.getElementById('PIDVI-input-2').value;
        dataObject.PIDVI[elementNumber].D = document.getElementById('PIDVI-input-3').value;

        findTimerExecutor(dataObject.PIDVI[elementNumber]);
    }

    function setTextVI(elementNumber) {

        closeBox();

        dataObject.TextVI[elementNumber].setDecimalPlace(document.getElementById('TextVI-input').value);

        findTimerExecutor(dataObject.TextVI[elementNumber]);
    }

    function setDCOutputVI(elementNumber) {

        closeBox();

        dataObject.DCOutputVI[elementNumber].setData(document.getElementById('DCOutputVI-input').value);

        findTimerExecutor(dataObject.DCOutputVI[elementNumber]);
    }

    function setKnobVI(elementNumber) {

        closeBox();

        var minValue = document.getElementById('KnobVI-input-1').value;
        var maxValue = document.getElementById('KnobVI-input-2').value;
        var defaultValue = document.getElementById('KnobVI-input-3').value;

        dataObject.KnobVI[elementNumber].setDataRange(minValue, maxValue, defaultValue);

        findTimerExecutor(dataObject.KnobVI[elementNumber]);
    }

    /**
     * 比例
     */
    function setProportionalResponseVI(elementNumber) {

        closeBox();

        dataObject.ProportionalResponseVI[elementNumber].k1 = document.getElementById('ProportionalResponseVI-input').value;

        findTimerExecutor(dataObject.ProportionalResponseVI[elementNumber]);
    }

    /**
     * 积分
     */
    function setIntegralResponseVI(elementNumber) {

        closeBox();

        dataObject.IntegralResponseVI[elementNumber].k2 = document.getElementById('IntegralResponseVI-input').value;

        findTimerExecutor(dataObject.IntegralResponseVI[elementNumber]);
    }

    /**
     * 微分
     */
    function setDifferentialResponseVI(elementNumber) {

        closeBox();

        dataObject.DifferentialResponseVI[elementNumber].k3 = document.getElementById('DifferentialResponseVI-input').value;

        findTimerExecutor(dataObject.DifferentialResponseVI[elementNumber]);
    }

    /**
     * 惯性
     */
    function setInertiaResponseVI(elementNumber) {

        closeBox();

        dataObject.InertiaResponseVI[elementNumber].k1 = document.getElementById('InertiaResponseVI-input').value;

        findTimerExecutor(dataObject.InertiaResponseVI[elementNumber]);
    }

    /**
     * 震荡
     */
    function setOscillationResponseVI(elementNumber) {

        closeBox();

        dataObject.OscillationResponseVI[elementNumber].k1 = document.getElementById('OscillationResponseVI-input-1').value;
        dataObject.OscillationResponseVI[elementNumber].k2 = document.getElementById('OscillationResponseVI-input-2').value;

        findTimerExecutor(dataObject.OscillationResponseVI[elementNumber]);
    }

    /**
     * 比例积分
     */
    function setProportionalIntegralResponseVI(elementNumber) {

        closeBox();

        dataObject.ProportionalIntegralResponseVI[elementNumber].k1 = document.getElementById('ProportionalIntegralResponseVI-input-1').value;
        dataObject.ProportionalIntegralResponseVI[elementNumber].k2 = document.getElementById('ProportionalIntegralResponseVI-input-2').value;

        findTimerExecutor(dataObject.ProportionalIntegralResponseVI[elementNumber]);
    }

    /**
     * 比例微分
     */
    function setProportionalDifferentialResponseVI(elementNumber) {

        closeBox();

        dataObject.ProportionalDifferentialResponseVI[elementNumber].k1 = document.getElementById('ProportionalDifferentialResponseVI-input-1').value;
        dataObject.ProportionalDifferentialResponseVI[elementNumber].k3 = document.getElementById('ProportionalDifferentialResponseVI-input-2').value;

        findTimerExecutor(dataObject.ProportionalDifferentialResponseVI[elementNumber]);
    }

    /**
     * 比例惯性
     */
    function setProportionalInertiaResponseVI(elementNumber) {

        closeBox();

        dataObject.ProportionalInertiaResponseVI[elementNumber].k1 = document.getElementById('ProportionalInertiaResponseVI-input-1').value;
        dataObject.ProportionalInertiaResponseVI[elementNumber].k2 = document.getElementById('ProportionalInertiaResponseVI-input-2').value;

        findTimerExecutor(dataObject.ProportionalInertiaResponseVI[elementNumber]);
    }

    /**
     * 信号发生器
     */
    function setSignalGeneratorVI(elementNumber, type) {

        closeBox();

        dataObject.SignalGeneratorVI[elementNumber].signalType = type;

        findTimerExecutor(dataObject.SignalGeneratorVI[elementNumber]);
    }

    /**
     * 寻找用于启用Timer的VI
     */
    function findTimerExecutor(element) {
        if (element.runningFlag) {

            return;
        }
        var runningElementArr = [];
        window.setInterval(function () {
            onTimer(element, runningElementArr);
        }, 50);
    }

    /**
     * Timer函数
     * @param element   启动Timer的VI
     *@param runningElementArr    用来存储是否需要刷新数据标志
     */
    function onTimer(element, runningElementArr) {

        var i;
        for (i = 0; i < runningElementArr.length; i++) {

            runningElementArr[i].runningFlag = false;
        }

        findSourceElement(element, runningElementArr);
        findTargetElement(element, runningElementArr);
    }

    function findSourceElement(element, runningElementArr) {

        //添加element.runningFlag到标志位存储数组中
        if (runningElementArr.indexOf(element) == -1) {

            runningElementArr.push(element);
        }

        if (element.source == false || element.source == undefined) {

            if (!element.runningFlag) {

                element.setData(element.singleOutput);  //直流输出等VI，直接重复赋值以生成输出数组
                element.runningFlag = true;
            }

            return false;
        }
        else {

            var i;
            for (i = 0; i < element.source.length; i++) {

                if (!element.runningFlag) {

                    var j, sourceData;
                    //查找element对应的输入VI的输出参数
                    for (j = 0; j < element.source[i][0].target.length; j++) {

                        if (element.source[i][0].target[j][0] == element) {

                            sourceData = getOutput(element.source[i][0], element.source[i][0].target[j][1]);
                            break;
                        }
                    }

                    setElementData(element, sourceData, element.source[i][1]);

                    findSourceElement(element.source[i][0], runningElementArr);    //继续向前查找sourceVI
                    findTargetElement(element.source[i][0], runningElementArr);    //同时也向后查找当前sourceVI对应的其他targetVI
                }
            }
        }
    }

    function findTargetElement(element, runningElementArr) {

        if (element.target == false || element.target == undefined) {

            return false;
        }
        else {

            var i;
            for (i = 0; i < element.target.length; i++) {

                //添加element到标志位存储数组中
                if (runningElementArr.indexOf(element.target[i][0]) == -1) {

                    runningElementArr.push(element.target[i][0]);
                }
                if (!element.target[i][0].runningFlag) {

                    var j, sourceDataType;
                    //查找element.target的输入参数类型
                    for (j = 0; j < element.target[i][0].source.length; j++) {

                        if (element.target[i][0].source[j][0] == element) {

                            sourceDataType = element.target[i][0].source[j][1];
                            break;
                        }
                    }
                    var sourceData = getOutput(element, element.target[i][1]);

                    setElementData(element.target[i][0], sourceData, sourceDataType);

                    findTargetElement(element.target[i][0], runningElementArr);    //继续向后查找targetVI
                    findSourceElement(element.target[i][0], runningElementArr);    //同时向前查找当前targetVI对应的不同的sourceVI
                }
            }
        }
    }

    function setElementData(element, sourceData, sourceDataType) {

        if (element.name == 'AddVI') {

            if (sourceDataType == '1') {

                element.setOriginalData(sourceData);
                element.dataSetCount++;
            }
            else if (sourceDataType == '2') {

                element.setData(sourceData);
                element.dataSetCount++;
            }
            if (element.dataSetCount % 2 == 0) {

                element.runningFlag = true;
            }
        }
        else if (element.name == 'SignalGeneratorVI') {
            if (sourceDataType == '1') {

                element.amp = sourceData;
                element.dataSetCount++;
            }
            else if (sourceDataType == '2') {

                element.frequency = sourceData;
                element.dataSetCount++;
            }
            if (element.dataSetCount % 2 == 0) {

                element.phase += 10;
                element.setData(element.amp, element.frequency, element.phase);
                element.runningFlag = true;
            }
        }
        else {

            element.setData(sourceData);
            element.runningFlag = true;
        }
    }

    function getOutput(element, outputType) {

        if (element.name == 'BallBeamVI') {

            if (outputType == 1) {

                return element.PIDAngle;  //输出角度单值

            } else if (outputType == 2) {

                return element.PIDPosition;  //输出位置单值

            } else if (outputType == 3) {

                return element.angelOutput;  //输出角度数组

            } else if (outputType == 4) {

                return element.positionOutput;  //输出位置数组

            } else if (outputType == 5) {

                return element.markPosition;  //输出标记位置
            }
        }
        else {
            if (outputType == 1) {

                return element.singleOutput;  //输出单值

            } else if (outputType == 2) {

                return element.output;  //输出数组
            }
        }
    }

    function allowDrop(e) {

        e.preventDefault();
    }

    function drag(e) {

        e.dataTransfer.setData('Text', e.target.id);
    }

    function drop(e) {

        e.preventDefault();
        var VICanvas = document.getElementById(e.dataTransfer.getData('Text'));
        var newVICanvas = document.createElement('canvas');
        for (var i = 0; i < VICanvas.attributes.length - 3; i++) {
            newVICanvas.setAttribute(VICanvas.attributes.item(i).nodeName, VICanvas.getAttribute(VICanvas.attributes.item(i).nodeName));
        }
        switch (VICanvas.id.split('-')[0]) {

            case 'BallBeamVI':
                if (dataObject.BallBeamVICount > 0) {
                    G.alert('球杆实验已添加！', 1, 1500);
                    return;
                }
                newVICanvas.id = VICanvas.id + '-' + dataObject.BallBeamVICount++;
                break;
            case 'WaveVI':
                newVICanvas.id = VICanvas.id + '-' + dataObject.WaveVICount++;
                break;

            case 'AddVI':
                newVICanvas.id = VICanvas.id + '-' + dataObject.AddVICount++;
                break;

            case 'TextVI':
                newVICanvas.id = VICanvas.id + '-' + dataObject.TextVICount++;
                break;

            case 'DCOutputVI':
                newVICanvas.id = VICanvas.id + '-' + dataObject.DCOutputVICount++;
                break;

            case 'KnobVI':
                newVICanvas.id = VICanvas.id + '-' + dataObject.KnobVICount++;
                break;

            case 'PIDVI':
                newVICanvas.id = VICanvas.id + '-' + dataObject.PIDVICount++;
                break;

            case 'RelayVI':
                newVICanvas.id = VICanvas.id + '-' + dataObject.RelayVICount++;
                break;

            case 'ProportionalResponseVI':
                if (dataObject.ProportionalResponseVICount > 0) {
                    G.alert('比例响应已存在！', 1, 1500);
                    return;
                }
                newVICanvas.id = VICanvas.id + '-' + dataObject.ProportionalResponseVICount++;
                break;

            case 'IntegralResponseVI':
                if (dataObject.IntegralResponseVICount > 0) {
                    G.alert('积分响应已存在！', 1, 1500);
                    return;
                }
                newVICanvas.id = VICanvas.id + '-' + dataObject.IntegralResponseVICount++;
                break;

            case 'DifferentialResponseVI':
                if (dataObject.DifferentialResponseVICount > 0) {
                    G.alert('微分响应已存在！', 1, 1500);
                    return;
                }
                newVICanvas.id = VICanvas.id + '-' + dataObject.DifferentialResponseVICount++;
                break;

            case 'InertiaResponseVI':
                if (dataObject.InertiaResponseVICount > 0) {
                    G.alert('惯性响应已存在！', 1, 1500);
                    return;
                }
                newVICanvas.id = VICanvas.id + '-' + dataObject.InertiaResponseVICount++;
                break;

            case 'OscillationResponseVI':
                if (dataObject.OscillationResponseVICount > 0) {
                    G.alert('震荡响应已存在！', 1, 1500);
                    return;
                }
                newVICanvas.id = VICanvas.id + '-' + dataObject.OscillationResponseVICount++;
                break;

            case 'ProportionalIntegralResponseVI':
                if (dataObject.ProportionalIntegralResponseVICount > 0) {
                    G.alert('比例积分响应已存在！', 1, 1500);
                    return;
                }
                newVICanvas.id = VICanvas.id + '-' + dataObject.ProportionalIntegralResponseVICount++;
                break;

            case 'ProportionalDifferentialResponseVI':
                if (dataObject.ProportionalDifferentialResponseVICount > 0) {
                    G.alert('比例微分响应已存在！', 1, 1500);
                    return;
                }
                newVICanvas.id = VICanvas.id + '-' + dataObject.ProportionalDifferentialResponseVICount++;
                break;

            case 'ProportionalInertiaResponseVI':
                if (dataObject.ProportionalInertiaResponseVICount > 0) {
                    G.alert('比例惯性响应已存在！', 1, 1500);
                    return;
                }
                newVICanvas.id = VICanvas.id + '-' + dataObject.ProportionalInertiaResponseVICount++;
                break;

            case 'SignalGeneratorVI':
                if (dataObject.SignalGeneratorVICount > 0) {
                    G.alert('信号发生器已存在！', 1, 1500);
                    return;
                }
                newVICanvas.id = VICanvas.id + '-' + dataObject.SignalGeneratorVICount++;
                break;
        }
        newVICanvas.setAttribute('oncontextmenu', 'toggleDrag(event, this)');
        newVICanvas.width = VICanvas.width * VICanvas.getAttribute('zoom');
        newVICanvas.height = VICanvas.height * VICanvas.getAttribute('zoom');
        newVICanvas.style.left = (e.offsetX - newVICanvas.width / 2) + 'px';
        newVICanvas.style.top = (e.offsetY - newVICanvas.height / 2) + 'px';
        VIDraw(newVICanvas);
    }

    function checkIfThreeDVIStarted(threeDElement) {

        if (threeDElement.isStart) {

            findTimerExecutor(threeDElement);
        }
    }

    function VIDraw(canvas) {

        instance.getContainer().appendChild(canvas);
        instance.draggable(canvas);
        var elementInfo = canvas.id.split('-');
        switch (elementInfo[0]) {

            case 'AddVI':
                dataObject.AddVI.push(new AddVI(canvas));
                addEndpoints(canvas.id, ['RightMiddle'], ['LeftMiddle'], -1, 2);
                break;

            case 'BallBeamVI':
                dataObject.BallBeamVI.push(new BallBeamVI(canvas, true));
                addEndpoints(canvas.id, ['RightMiddle'], ['LeftMiddle'], -1, 1);
                break;

            case 'DCOutputVI':
                dataObject.DCOutputVI.push(new DCOutputVI(canvas));
                addEndpoints(canvas.id, ['RightMiddle'], [], -1, 0);
                break;

            case 'DifferentialResponseVI':
                dataObject.DifferentialResponseVI.push(new DifferentialResponseVI(canvas));
                addEndpoints(canvas.id, ['RightMiddle'], ['LeftMiddle'], -1, 1);
                break;

            case 'InertiaResponseVI':
                dataObject.InertiaResponseVI.push(new InertiaResponseVI(canvas));
                addEndpoints(canvas.id, ['RightMiddle'], ['LeftMiddle'], -1, 1);
                break;

            case 'IntegralResponseVI':
                dataObject.IntegralResponseVI.push(new IntegralResponseVI(canvas));
                addEndpoints(canvas.id, ['RightMiddle'], ['LeftMiddle'], -1, 1);
                break;

            case 'KnobVI':
                dataObject.KnobVI.push(new KnobVI(canvas));
                addEndpoints(canvas.id, ['TopCenter'], [], -1, 0);
                break;

            case 'OscillationResponseVI':
                dataObject.OscillationResponseVI.push(new OscillationResponseVI(canvas));
                addEndpoints(canvas.id, ['RightMiddle'], ['LeftMiddle'], -1, 1);
                break;

            case 'PIDVI':
                dataObject.PIDVI.push(new PIDVI(canvas));
                addEndpoints(canvas.id, ['RightMiddle'], ['LeftMiddle'], -1, 1);
                break;

            case 'ProportionalDifferentialResponseVI':
                dataObject.ProportionalDifferentialResponseVI.push(new ProportionalDifferentialResponseVI(canvas));
                addEndpoints(canvas.id, ['RightMiddle'], ['LeftMiddle'], -1, 1);
                break;

            case 'ProportionalInertiaResponseVI':
                dataObject.ProportionalInertiaResponseVI.push(new ProportionalInertiaResponseVI(canvas));
                addEndpoints(canvas.id, ['RightMiddle'], ['LeftMiddle'], -1, 1);
                break;

            case 'ProportionalIntegralResponseVI':
                dataObject.ProportionalIntegralResponseVI.push(new ProportionalIntegralResponseVI(canvas));
                addEndpoints(canvas.id, ['RightMiddle'], ['LeftMiddle'], -1, 1);
                break;

            case 'ProportionalResponseVI':
                dataObject.ProportionalResponseVI.push(new ProportionalResponseVI(canvas));
                addEndpoints(canvas.id, ['RightMiddle'], ['LeftMiddle'], -1, 1);
                break;

            case 'RelayVI':
                dataObject.RelayVI.push(new RelayVI(canvas));
                addEndpoints(canvas.id, ['RightMiddle'], ['LeftMiddle'], -1, 1);
                break;

            case 'SignalGeneratorVI':
                dataObject.SignalGeneratorVI.push(new SignalGeneratorVI(canvas));
                addEndpoints(canvas.id, ['RightMiddle'], ['LeftMiddle'], -1, 2);
                break;

            case 'TextVI':
                dataObject.TextVI.push(new TextVI(canvas));
                dataObject.TextVI[dataObject.TextVICount - 1].setData(0);
                addEndpoints(canvas.id, [], ['LeftMiddle'], 0, 1);
                break;

            case 'WaveVI':
                dataObject.WaveVI.push(new WaveVI(canvas));
                addEndpoints(canvas.id, [], ['LeftMiddle'], 0, 1);
                break;
        }
    }

    /**
     *添加节点
     * @param toId 元素ID
     * @param sourceAnchors 输出节点
     * @param targetAnchors 输入节点
     * @param sourcePointCount 输出节点允许最大连接数
     * @param targetPointCount 输入节点允许最大连接数
     */
    function addEndpoints(toId, sourceAnchors, targetAnchors, sourcePointCount, targetPointCount) {

        // this is the paint style for the connecting lines..
        var connectorPaintStyle = {
                    strokeWidth: 2,
                    stroke: '#61B7CF',
                    joinstyle: 'round',
                    outlineStroke: 'white',
                    outlineWidth: 2
                },
                // .. and this is the hover style.
                connectorHoverStyle = {
                    strokeWidth: 3,
                    stroke: '#216477',
                    outlineWidth: 5,
                    outlineStroke: 'white'
                },
                endpointHoverStyle = {
                    fill: '#216477',
                    stroke: '#216477'
                },
                // the definition of source endpoints (the small blue ones)
                sourceEndpoint = {
                    endpoint: 'Dot',
                    paintStyle: {
                        stroke: '#7AB02C',
                        fill: 'transparent',
                        radius: 7,
                        strokeWidth: 1
                    },
                    isSource: true,
                    maxConnections: sourcePointCount, //设置最大连接个数，-1为不限制
                    connector: ['Flowchart', {stub: [10, 15], gap: 10, cornerRadius: 5, alwaysRespectStubs: true}],
                    connectorStyle: connectorPaintStyle,
                    hoverPaintStyle: endpointHoverStyle,
                    connectorHoverStyle: connectorHoverStyle,
                    dragOptions: {},
                    overlays: [
                        ['Label', {
                            location: [0.5, 1.5],
                            label: 'Drag',
                            cssClass: 'endpointSourceLabel',
                            visible: false
                        }]
                    ]
                },
                // the definition of target endpoints (will appear when the user drags a connection)
                targetEndpoint = {
                    endpoint: 'Dot',
                    paintStyle: {fill: '#7AB02C', radius: 7},
                    hoverPaintStyle: endpointHoverStyle,
                    maxConnections: targetPointCount,
                    dropOptions: {hoverClass: 'hover', activeClass: 'active'},
                    isTarget: true,
                    overlays: [
                        ['Label', {
                            location: [0.5, -0.5],
                            label: 'Drop',
                            cssClass: 'endpointTargetLabel',
                            visible: false
                        }]
                    ]
                };

        for (var i = 0; i < sourceAnchors.length; i++) {

            var sourceUUID = toId + '-' + sourceAnchors[i];
            instance.addEndpoint(toId, sourceEndpoint, {anchor: sourceAnchors[i], uuid: sourceUUID});
        }
        for (var j = 0; j < targetAnchors.length; j++) {

            var targetUUID = toId + '-' + targetAnchors[j];
            instance.addEndpoint(toId, targetEndpoint, {anchor: targetAnchors[j], uuid: targetUUID});
        }
    }

    /**
     * 右键点击锁定VI
     * @param e
     * @param element
     */
    function toggleDrag(e, element) {

        e = e || window.event;
        e.preventDefault(); //阻止右键默认菜单
        instance.toggleDraggable(element);
    }

    window.addEventListener('resize', resize, false);

    function resize() {

        var height = document.documentElement.clientHeight * 0.95 > 600 ? document.documentElement.clientHeight * 0.95 : 600;
        sideBar.style.height = height + 'px';
        VIContainer.style.height = height + 'px';
    }
</script>
</body>
</html>