<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no"/>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/draggable.css">
    <link rel="stylesheet" href="css/popup.css"/>
    <title>虚拟仪器实验</title>
</head>
<body onload="init()">
<div id="container-div" class="rowFlexDiv">
    <div class="draggable-sideBar" id="sideBar">
        <canvas id="WaveVI-canvas" class="draggable-element" width="162" height="90"
                zoom="3"
                draggable="true"
                ondragstart="drag(event)">
        </canvas>
        <canvas id="BallBeamVI-canvas" class="draggable-element" width="162" height="90"
                zoom="1"
                draggable="true"
                ondragstart="drag(event)">
        </canvas>
        <canvas id="TextVI-canvas" class="draggable-element" width="104" height="45"
                ondblclick="showBox(this)"
                zoom="1"
                draggable="true"
                ondragstart="drag(event)">
        </canvas>
        <canvas id="KnobVI-canvas" class="draggable-element" width="45" height="45"
                ondblclick="showBox(this)"
                zoom="3"
                draggable="true"
                ondragstart="drag(event)">
        </canvas>
        <canvas id="ADDVI-canvas" class="draggable-element" width="45" height="45"
                ondblclick="showBox(this)"
                zoom="1"
                draggable="true"
                ondragstart="drag(event)">
        </canvas>
        <canvas id="DCOutputVI-canvas" class="draggable-element" width="45" height="45"
                ondblclick="showBox(this)"
                zoom="1"
                draggable="true"
                ondragstart="drag(event)">
        </canvas>
        <canvas id="PIDVI-canvas" class="draggable-element" width="45" height="45"
                ondblclick="showBox(this)"
                zoom="1"
                draggable="true"
                ondragstart="drag(event)">
        </canvas>
        <canvas id="ProportionalResponseVI-canvas" class="draggable-element" width="45" height="45"
                ondblclick="showBox(this)"
                zoom="1"
                draggable="true"
                ondragstart="drag(event)">
        </canvas>
        <canvas id="IntegralResponseVI-canvas" class="draggable-element" width="45" height="45"
                ondblclick="showBox(this)"
                zoom="1"
                draggable="true"
                ondragstart="drag(event)">
        </canvas>
        <canvas id="DifferentialResponseVI-canvas" class="draggable-element" width="45" height="45"
                ondblclick="showBox(this)"
                zoom="1"
                draggable="true"
                ondragstart="drag(event)">
        </canvas>
        <canvas id="InertiaResponseVI-canvas" class="draggable-element" width="45" height="45"
                ondblclick="showBox(this)"
                zoom="1"
                draggable="true"
                ondragstart="drag(event)">
        </canvas>
        <canvas id="OscillationResponseVI-canvas" class="draggable-element" width="45" height="45"
                ondblclick="showBox(this)"
                zoom="1"
                draggable="true"
                ondragstart="drag(event)">
        </canvas>
        <canvas id="ProportionalIntegralResponseVI-canvas" class="draggable-element" width="45" height="45"
                ondblclick="showBox(this)"
                zoom="1"
                draggable="true"
                ondragstart="drag(event)">
        </canvas>
        <canvas id="ProportionalDifferentialResponseVI-canvas" class="draggable-element" width="45" height="45"
                ondblclick="showBox(this)"
                zoom="1"
                draggable="true"
                ondragstart="drag(event)">
        </canvas>
        <canvas id="ProportionalInertiaResponseVI-canvas" class="draggable-element" width="45" height="45"
                ondblclick="showBox(this)"
                zoom="1"
                draggable="true"
                ondragstart="drag(event)">
        </canvas>
        <canvas id="SignalGeneratorVI-canvas" class="draggable-element" width="45" height="45"
                ondblclick="showBox(this)"
                zoom="1"
                draggable="true"
                ondragstart="drag(event)">
        </canvas>
    </div>
    <div id="mainVI" class="VI-div">
        <div id="container" class="draggable-div" ondrop="drop(event)" ondragover="allowDrop(event)">
        </div>
    </div>
</div>
<div id="loadingDiv" class="loadingDiv">
    <img class="loadingImg" src="img/loading.gif" alt="loading">
</div>
<!--虚拟仪器库-->
<script src="js/VILibraries/BallBeamVI.js"></script>
<script src="js/VILibraries/WaveVI.js"></script>
<script src="js/VILibraries/ADDVI.js"></script>
<script src="js/VILibraries/DCOutputVI.js"></script>
<script src="js/VILibraries/KnobVI.js"></script>
<script src="js/VILibraries/PIDVI.js"></script>
<script src="js/VILibraries/TextVI.js"></script>
<script src="js/VILibraries/DifferentialResponseVI.js"></script>
<script src="js/VILibraries/InertiaResponseVI.js"></script>
<script src="js/VILibraries/IntegralResponseVI.js"></script>
<script src="js/VILibraries/OscillationResponseVI.js"></script>
<script src="js/VILibraries/ProportionalDifferentialResponseVI.js"></script>
<script src="js/VILibraries/ProportionalInertiaResponseVI.js"></script>
<script src="js/VILibraries/ProportionalIntegralResponseVI.js"></script>
<script src="js/VILibraries/ProportionalResponseVI.js"></script>
<script src="js/VILibraries/SignalGeneratorVI.js"></script>
<script src="js/VILibraries/BallBeamVI.js"></script>
<!--三维显示库-->
<script src="js/three.js"></script>
<script src="js/MTLLoader.js"></script>
<script src="js/OBJLoader.js"></script>
<script src="js/controls/OrbitControls.js"></script>
<script src="js/ObjectControls.js"></script>
<!--拖拽连线库-->
<script src="js/jsPlumb-2.2.2.js"></script>
<!--弹出框-->
<script src="js/popup.js"></script>
<script>

    var loadingDiv = document.getElementById('loadingDiv');

    //0为sideBar，1为拖动框，2为右侧主框，4为提示文字，用于调整布局
    var mainElement = [];
    mainElement[0] = document.getElementById('sideBar');
    mainElement[1] = document.getElementById('container');
    mainElement[2] = document.getElementById('mainVI');

    var instance;
    var dataSetBox, inputSetBox, outputSetBox;
    var dataObject = {
        THREECount: 0,
        BallBeamVICount: 0,
        WaveVICount: 0,
        ADDVICount: 0,
        DCOutputVICount: 0,
        KnobVICount: 0,
        PIDVICount: 0,
        TextVICount: 0,
        ProportionalResponseVICount: 0,
        IntegralResponseVICount: 0,
        DifferentialResponseVICount: 0,
        InertiaResponseVICount: 0,
        OscillationResponseVICount: 0,
        ProportionalIntegralResponseVICount: 0,
        ProportionalDifferentialResponseVICount: 0,
        ProportionalInertiaResponseVICount: 0,
        SignalGeneratorVICount: 0,
        THREE: [],
        BallBeamVI: [],
        WaveVI: [],
        ADDVI: [],
        DCOutputVI: [],
        KnobVI: [],
        PIDVI: [],
        TextVI: [],
        ProportionalResponseVI: [],
        IntegralResponseVI: [],
        DifferentialResponseVI: [],
        InertiaResponseVI: [],
        OscillationResponseVI: [],
        ProportionalIntegralResponseVI: [],
        ProportionalDifferentialResponseVI: [],
        ProportionalInertiaResponseVI: [],
        SignalGeneratorVI: []
    };

    function init() {
        new BallBeamVI(document.getElementById('BallBeamVI-canvas'));
        new WaveVI(document.getElementById('WaveVI-canvas'));
        new AddVI(document.getElementById('ADDVI-canvas'));
        new DCOutputVI(document.getElementById('DCOutputVI-canvas'));
        new KnobVI(document.getElementById('KnobVI-canvas'));
        new PIDVI(document.getElementById('PIDVI-canvas'));
        new TextVI(document.getElementById('TextVI-canvas'));
        new ProportionalResponseVI(document.getElementById('ProportionalResponseVI-canvas'));
        new IntegralResponseVI(document.getElementById('IntegralResponseVI-canvas'));
        new DifferentialResponseVI(document.getElementById('DifferentialResponseVI-canvas'));
        new InertiaResponseVI(document.getElementById('InertiaResponseVI-canvas'));
        new OscillationResponseVI(document.getElementById('OscillationResponseVI-canvas'));
        new ProportionalIntegralResponseVI(document.getElementById('ProportionalIntegralResponseVI-canvas'));
        new ProportionalDifferentialResponseVI(document.getElementById('ProportionalDifferentialResponseVI-canvas'));
        new ProportionalInertiaResponseVI(document.getElementById('ProportionalInertiaResponseVI-canvas'));
        new SignalGeneratorVI(document.getElementById('SignalGeneratorVI-canvas'));
        ready();
        resize();
    }

    function ready() {

        instance = window.jsp = jsPlumb.getInstance({
            // default drag options
            DragOptions: {cursor: 'pointer', zIndex: 2000},
            // the overlays to decorate each connection with.  note that the label overlay uses a function to generate the label text;
            // in this case it returns the 'labelText' member that we set on each connection in the 'init' method below.
            ConnectionOverlays: [
                ['Arrow', {
                    location: 1,
                    visible: true,
                    width: 11,
                    length: 11,
                    id: 'ARROW',
                    events: {
                        click: function () {
//                            alert('you clicked on the arrow overlay')
                            //点击箭头事件
                        }
                    }
                }]
            ],
            Container: 'container'
        });

        var basicType = {
            connector: 'StateMachine',
            paintStyle: {stroke: 'red', strokeWidth: 4},
            hoverPaintStyle: {stroke: 'blue'},
            overlays: ['Arrow']
        };

        instance.registerConnectionType('basic', basicType);

        // suspend drawing and initialise.
        instance.batch(function () {

            // 监听连线事件
            instance.bind('connection', function (connectionInfo) {

                var sourceArr = connectionInfo.connection.sourceId.split('-');
                var targetArr = connectionInfo.connection.targetId.split('-');
                var sourceElement = getObjectVIByName(sourceArr[0])[sourceArr[2]];
                var targetElement = getObjectVIByName(targetArr[0])[targetArr[2]];

                //对多输出控件判断
                if (sourceElement.name == 'BallBeamVI') {

                    outputSetBox = G.box('请选择' + sourceElement.cnText + '输出参数&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
                            '<div style="margin: 10px 10px; font-size: 1em; ">' +
                            '<input type="radio" class="radioInput" name="output-type" value="1" onclick="outputSetBox.close()">反馈角度(单值)<br>' +
                            '<input type="radio" class="radioInput" name="output-type" value="2" onclick="outputSetBox.close()">反馈位置(单值)<br>' +
                            '<input type="radio" class="radioInput" name="output-type" value="3" onclick="outputSetBox.close()">反馈角度(数组)<br>' +
                            '<input type="radio" class="radioInput" name="output-type" value="4" onclick="outputSetBox.close()">反馈位置(数组)<br>' +
                            '</div>',
                            1, function () {

                                var outputType = document.getElementsByName('output-type');
                                var checkedValue = -1;
                                for (var i = 0; i < outputType.length; i++) {

                                    if (outputType[i].checked == true) {

                                        checkedValue = outputType[i].value;
                                    }
                                }
                                if (checkedValue == -1) {

                                    instance.detach(connectionInfo.connection);
                                    G.alert('未选择' + sourceElement.cnText + '输出参数！', 1, 1000);
                                    return;
                                }

                                sourceElement.target.push([targetElement, checkedValue]);
                            });
                }
                else if (sourceElement.outputCount == 2) {

                    outputSetBox = G.box('请选择' + sourceElement.cnText + '输出参数&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
                            '<div style="margin: 10px 10px; font-size: 1em; ">' +
                            '<input type="radio" class="radioInput" name="output-type" value="1" onclick="outputSetBox.close()">输出(单值)<br>' +
                            '<input type="radio" class="radioInput" name="output-type" value="2" onclick="outputSetBox.close()">输出(数组)<br>' +
                            '</div>',
                            1, function () {

                                var outputType = document.getElementsByName('output-type');
                                var checkedValue = -1;
                                for (var i = 0; i < outputType.length; i++) {

                                    if (outputType[i].checked == true) {

                                        checkedValue = outputType[i].value;
                                    }
                                }
                                if (checkedValue == -1) {

                                    instance.detach(connectionInfo.connection);
                                    G.alert('未选择' + sourceElement.cnText + '输出参数！', 1, 1000);
                                    return;
                                }

                                sourceElement.target.push([targetElement, checkedValue]);
                            });
                }
                else {

                    sourceElement.target.push([targetElement, 0]);
                }

                //对于多输入控件,进行输入端口判断
                if (targetElement.name == 'ADDVI') {

                    inputSetBox = G.box('请选择' + targetElement.cnText + '输入参数&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
                            '<div style="margin: 10px 10px; font-size: 1em; ">' +
                            '<input type="radio" class="radioInput" name="ADDVI-type" value="1" onclick="inputSetBox.close()">初值<br>' +
                            '<input type="radio" class="radioInput" name="ADDVI-type" value="2" onclick="inputSetBox.close()">反馈值<br>' +
                            '</div>',
                            1, function () {

                                var inputType = document.getElementsByName('ADDVI-type');
                                var checkedValue = -1;
                                for (var i = 0; i < inputType.length; i++) {

                                    if (inputType[i].checked == true) {

                                        checkedValue = inputType[i].value;
                                    }
                                }
                                if (checkedValue == -1) {

                                    instance.detach(connectionInfo.connection);
                                    G.alert('未选择' + targetElement.cnText + '输入参数！', 1, 1000);
                                    return;
                                }
                                targetElement.source.push([sourceElement, checkedValue]);
                            }
                    );
                }
                else if (targetElement.name == 'SignalGeneratorVI') {

                    inputSetBox = G.box('请选择' + targetElement.cnText + '输入参数&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
                            '<div style="margin: 10px 10px; font-size: 1em; ">' +
                            '<input type="radio" class="radioInput" name="SignalGeneratorVI-type" value="1" onclick="inputSetBox.close()">幅值<br>' +
                            '<input type="radio" class="radioInput" name="SignalGeneratorVI-type" value="2" onclick="inputSetBox.close()">频率<br>' +
                            '</div>',
                            1, function () {

                                var inputType = document.getElementsByName('SignalGeneratorVI-type');
                                var checkedValue = -1;
                                for (var i = 0; i < inputType.length; i++) {

                                    if (inputType[i].checked == true) {

                                        checkedValue = inputType[i].value;
                                    }
                                }
                                if (checkedValue == -1) {

                                    instance.detach(connectionInfo.connection);
                                    G.alert('未选择' + targetElement.cnText + '输入参数！', 1, 1000);
                                    return;
                                }
                                targetElement.source.push([sourceElement, checkedValue]);
                            }
                    );
                }
                else {

                    targetElement.source[0] = [sourceElement, 0];
                }
            });

            // 绑定点击删除连线
            instance.bind('click', function (conn) {
                if (confirm("删除连接?")) {

                    instance.detach(conn);
                }
            });

            //监听断开连线事件
            instance.bind('connectionDetached', function (connectionInfo) {

                var sourceArr = connectionInfo.connection.sourceId.split('-');
                var targetArr = connectionInfo.connection.targetId.split('-');
                var sourceElement = getObjectVIByName(sourceArr[0])[sourceArr[2]];
                var targetElement = getObjectVIByName(targetArr[0])[targetArr[2]];

                var i;
                for (i = 0; i < sourceElement.target.length; i++) {

                    if (sourceElement.target[i][0] == targetElement) {

                        sourceElement.target.splice(i, 1);
                        break;
                    }
                }
                for (i = 0; i < targetElement.source.length; i++) {

                    if (targetElement.source[i][0] == sourceElement) {

                        targetElement.source.splice(i, 1);
                        break;
                    }
                }
            });
        });

        jsPlumb.fire('jsPlumbDemoLoaded', instance);

    }

    function getObjectVIByName(name) {

        switch (name) {

            case 'BallBeamVI':
                return dataObject.BallBeamVI;

            case 'WaveVI':
                return dataObject.WaveVI;

            case 'DCOutputVI':
                return dataObject.DCOutputVI;

            case 'KnobVI':
                return dataObject.KnobVI;

            case 'PIDVI':
                return dataObject.PIDVI;
            case 'TextVI':
                return dataObject.TextVI;

            case 'ADDVI':
                return dataObject.ADDVI;

            case 'ProportionalResponseVI':
                return dataObject.ProportionalResponseVI;

            case 'IntegralResponseVI':
                return dataObject.IntegralResponseVI;

            case 'DifferentialResponseVI':
                return dataObject.DifferentialResponseVI;

            case 'InertiaResponseVI':
                return dataObject.InertiaResponseVI;

            case 'OscillationResponseVI':
                return dataObject.OscillationResponseVI;

            case 'ProportionalIntegralResponseVI':
                return dataObject.ProportionalIntegralResponseVI;

            case 'ProportionalDifferentialResponseVI':
                return dataObject.ProportionalDifferentialResponseVI;

            case 'ProportionalInertiaResponseVI':
                return dataObject.ProportionalInertiaResponseVI;

            case 'SignalGeneratorVI':
                return dataObject.SignalGeneratorVI;
        }
    }

    function showBox(element) {
        var elementInfo = element.id.split('-');
        switch (elementInfo[0]) {


            case 'ADDVI':
                dataSetBox = G.box('请输入初始值&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
                        '<div style="margin: 10px 10px; font-size: 1em; ">' +
                        '<span class="normalSpan">初值:</span><input type="number" id="ADD-input" value="20" class="normalInput"><br>' +
                        '</div>', 1, function () {
                        });
                break;

            case 'PIDVI':
                dataSetBox = G.box('请输入PID参数&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
                        '<div style="margin: 10px 10px; font-size: 1em; ">' +
                        '<span class="normalSpan">P:</span><input type="number" id="P-input" value="20" class="normalInput">' +
                        '<span class="normalSpan">I:</span><input type="number" id="I-input" value="0" class="normalInput">' +
                        '<span class="normalSpan">D:</span><input type="number" id="D-input" value="20" class="normalInput">' +
                        '<button id="startBtn" class="normalBtn" onclick="setPIDVI(' + elementInfo[2] + ')">确定</button>' +
                        '</div>',
                        1, function () {
                        });
                break;

            case 'TextVI':
                dataSetBox = G.box('请输入保留小数位&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
                        '<div style="margin: 10px 10px; font-size: 1em; ">' +
                        '<input type="number" id="TextVI-input" value="1" class="normalInput">' +
                        '<button id="startBtn" class="normalBtn" onclick="setTextVI(' + elementInfo[2] + ')">确定</button>' +
                        '</div>',
                        1, function () {
                        });
                break;

            case 'DCOutputVI':
                dataSetBox = G.box('请设置输出值&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
                        '<div style="margin: 10px 10px; font-size: 1em; ">' +
                        '<span class="normalSpan">初值:</span><input type="number" id="DCOutputVI-input" value="100" class="normalInput">' +
                        '<button id="startBtn" class="normalBtn" onclick="setDCOutputVI(' + elementInfo[2] + ')">确定</button>' +
                        '</div>',
                        1, function () {
                        });
                break;

            case 'KnobVI':
                dataSetBox = G.box('请输入初始值&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
                        '<div style="margin: 10px 10px; font-size: 1em; ">' +
                        '<span class="normalSpan">最小值:</span><input type="number" id="DCOutputVI-input-1" value="0" class="normalInput">' +
                        '<span class="normalSpan">最大值:</span><input type="number" id="DCOutputVI-input-2" value="1" class="normalInput">' +
                        '<span class="normalSpan">初值:</span><input type="number" id="DCOutputVI-input-3" value="0" class="normalInput">' +
                        '<button id="startBtn" class="normalBtn" onclick="setKnobVI(' + elementInfo[2] + ')">确定</button>' +
                        '</div>',
                        1, function () {
                        });
                break;

            case 'ProportionalResponseVI':
                dataSetBox = G.box('比例响应&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
                        '<div style="margin: 10px 10px; font-size: 1em; ">' +
                        '<span class="normalSpan">K1:</span><input type="number" id="ProportionalResponseVI-input" value="1.5" class="normalInput">' +
                        '<button id="startBtn" class="normalBtn" onclick="setStepResponseData(1)">确定</button>' +
                        '</div>',
                        1, function () {
                        });
                break;

            case 'IntegralResponseVI':
                dataSetBox = G.box('积分响应&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
                        '<div style="margin: 10px 10px; font-size: 1em; ">' +
                        '<span class="normalSpan">K2:</span><input type="number" id="IntegralResponseVI-input" value="5" class="normalInput">' +
                        '<button id="startBtn" class="normalBtn" onclick="setStepResponseData(2)">确定</button>' +
                        '</div>',
                        1, function () {
                        });
                break;

            case 'DifferentialResponseVI':
                dataSetBox = G.box('微分响应&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
                        '<div style="margin: 10px 10px; font-size: 1em; ">' +
                        '<span class="normalSpan">K3:</span><input type="number" id="DifferentialResponseVI-input" value="0.0025" class="normalInput">' +
                        '<button id="startBtn" class="normalBtn" onclick="setStepResponseData(3)">确定</button>' +
                        '</div>',
                        1, function () {
                        });
                break;

            case 'InertiaResponseVI':
                dataSetBox = G.box('惯性响应&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
                        '<div style="margin: 10px 10px; font-size: 1em; ">' +
                        '<span class="normalSpan">K:</span><input type="number" id="InertiaResponseVI-input" value="0.025" class="normalInput">' +
                        '<button id="startBtn" class="normalBtn" onclick="setStepResponseData(4)">确定</button>' +
                        '</div>',
                        1, function () {
                        });
                break;

            case 'OscillationResponseVI':
                dataSetBox = G.box('震荡响应&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
                        '<div style="margin: 10px 10px; font-size: 1em; ">' +
                        '<span class="normalSpan">K1:</span><input type="number" id="OscillationResponseVI-input-1" value="50" class="normalInput">' +
                        '<span class="normalSpan">K2:</span><input type="number" id="OscillationResponseVI-input-2" value="0.05" class="normalInput">' +
                        '<button id="startBtn" class="normalBtn" onclick="setStepResponseData(5)">确定</button>' +
                        '</div>',
                        1, function () {
                        });
                break;

            case 'ProportionalIntegralResponseVI':
                dataSetBox = G.box('比例积分响应&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
                        '<div style="margin: 10px 10px; font-size: 1em; ">' +
                        '<span class="normalSpan">K1:</span><input type="number" id="ProportionalDifferentialResponseVI-input-1" value="1" class="normalInput">' +
                        '<span class="normalSpan">K2:</span><input type="number" id="ProportionalDifferentialResponseVI-input-2" value="1" class="normalInput">' +
                        '<button id="startBtn" class="normalBtn" onclick="setStepResponseData(6)">确定</button>' +
                        '</div>',
                        1, function () {
                        });
                break;

            case 'ProportionalDifferentialResponseVI':
                dataSetBox = G.box('比例微分响应&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
                        '<div style="margin: 10px 10px; font-size: 1em; ">' +
                        '<span class="normalSpan">K1:</span><input type="number" id="ProportionalResponseVI-input-1" value="1" class="normalInput">' +
                        '<span class="normalSpan">K3:</span><input type="number" id="ProportionalResponseVI-input-2" value="1" class="normalInput">' +
                        '<button id="startBtn" class="normalBtn" onclick="setStepResponseData(7)">确定</button>' +
                        '</div>',
                        1, function () {
                        });
                break;

            case 'ProportionalInertiaResponseVI':
                dataSetBox = G.box('比例惯性响应&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
                        '<div style="margin: 10px 10px; font-size: 1em; ">' +
                        '<span class="normalSpan">K1:</span><input type="number" id="ProportionalInertiaResponseVI-input-1" value="1" class="normalInput">' +
                        '<span class="normalSpan">K2:</span><input type="number" id="ProportionalInertiaResponseVI-input-2" value="1" class="normalInput">' +
                        '<button id="startBtn" class="normalBtn" onclick="setStepResponseData(8)">确定</button>' +
                        '</div>',
                        1, function () {
                        });
                break;

            case 'SignalGeneratorVI':
                dataSetBox = G.box('请选择信号类型&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;',
                        '<div style="margin: 10px 10px; font-size: 1em; ">' +
                        '<input type="radio" class="radioInput" name="SignalGeneratorVI-type" value="1" onclick="setSignalType(this.value,' + elementInfo[2] + ')">正弦波<br>' +
                        '<input type="radio" class="radioInput" name="SignalGeneratorVI-type" value="2" onclick="setSignalType(this.value,' + elementInfo[2] + ')">方波<br>' +
                        '<input type="radio" class="radioInput" name="SignalGeneratorVI-type" value="3" onclick="setSignalType(this.value,' + elementInfo[2] + ')">三角波<br>' +
                        '<input type="radio" class="radioInput" name="SignalGeneratorVI-type" value="4" onclick="setSignalType(this.value,' + elementInfo[2] + ')">白噪声<br>' +
                        '</div>',
                        1, function () {
                        });
                break;
        }

    }

    function setPIDVI(elementNumber) {

        if (dataSetBox) {

            dataSetBox.close();
        }

        dataObject.PIDVI[elementNumber].P = document.getElementById('P-input').value;
        dataObject.PIDVI[elementNumber].I = document.getElementById('I-input').value;
        dataObject.PIDVI[elementNumber].D = document.getElementById('D-input').value;
    }

    function setTextVI(elementNumber) {

        if (dataSetBox) {

            dataSetBox.close();
        }

        dataObject.TextVI[elementNumber].setDecimalPlace(document.getElementById('TextVI-input').value);

        findTimerExecutor(dataObject.TextVI[elementNumber]);
    }

    function setDCOutputVI(elementNumber) {

        if (dataSetBox) {

            dataSetBox.close();
        }

        dataObject.DCOutputVI[elementNumber].singleOutput = document.getElementById('DCOutputVI-input').value;
        findTimerExecutor(dataObject.DCOutputVI[elementNumber]);
    }

    function setKnobVI(elementNumber) {

        if (dataSetBox) {

            dataSetBox.close();
        }

        var minValue = document.getElementById('DCOutputVI-input-1').value;
        var maxValue = document.getElementById('DCOutputVI-input-2').value;
        var defaultValue = document.getElementById('DCOutputVI-input-3').value;
        dataObject.KnobVI[elementNumber].setDataRange(minValue, maxValue, defaultValue);
        findTimerExecutor(dataObject.KnobVI[elementNumber]);
    }

    /**
     * 寻找用于启用Timer的VI
     */
    function findTimerExecutor(element) {

        if (element.target == undefined) {
            //说明此VI为只有输入没有输出的连线尾，如波形显示
        }
        else if (element.source == false || element.source == undefined) {
            //说明此VI为只有输出没有输入的连线头，如旋钮，或未连接输入的VI

            if (element.target.length > 0) {
                //存在输出连线

                element.setData(element.singleOutput);
                window.setInterval(function () {
                    onTimer(element, 1);
                }, 50);
            }
        }
    }

    /**
     * Timer函数
     * @param element   启动Timer的VI
     * @param timerType VI类型，1为起点，2为第一个输入输出
     */
    function onTimer(element, timerType) {

        if (timerType == 1) {

            findTargetElement(element);
        }
    }

    function findTargetElement(element) {

        var i;
        for (i = 0; i < element.target.length; i++) {

            var data = getOutput(element, element.target[i][1]);
            setElementData(element.target[i][0], data);
        }
    }

    function setElementData(element, data) {

        element.setData(data);
        if (element.target != undefined) {

            if (element.target.length > 0) {
                findTargetElement(element);
            }
        }
    }

    function getOutput(element, outputType) {

        if (element.name == 'BallBeamVI') {

            if (outputType == 1) {

                return element.PIDAngle;  //输出角度单值

            } else if (outputType == 2) {

                return element.PIDPosition;  //输出位置单值

            } else if (outputType == 3) {

                return element.angelOutput;  //输出角度数组

            } else if (outputType == 4) {

                return element.positionOutput;  //输出位置数组

            }
        }
        else {
            if (outputType == 1) {

                return element.singleOutput;  //输出单值

            } else if (outputType == 2) {

                return element.output;  //输出数组
            }
        }
    }

    var stepResponse;

    function setStepResponseData(type) {

        if (dataSetBox) {

            dataSetBox.close();
        }

        switch (parseInt(type)) {

            case 1://比例
                dataObject.ProportionalResponseVI[0].k1 = document.getElementById('ProportionalResponseVI-input').value;
                stepResponse = dataObject.ProportionalResponseVI[0];
                break;

            case 2://积分
                dataObject.IntegralResponseVI[0].k2 = document.getElementById('IntegralResponseVI-input').value;
                stepResponse = dataObject.IntegralResponseVI[0];
                break;

            case 3://微分
                dataObject.DifferentialResponseVI[0].k3 = document.getElementById('DifferentialResponseVI-input').value;
                stepResponse = dataObject.DifferentialResponseVI[0];
                break;

            case 4://惯性
                dataObject.InertiaResponseVI[0].k1 = document.getElementById('InertiaResponseVI-input').value;
                stepResponse = dataObject.InertiaResponseVI[0];
                break;

            case 5://震荡
                dataObject.OscillationResponseVI[0].k1 = document.getElementById('OscillationResponseVI-input-1').value;
                dataObject.OscillationResponseVI[0].k2 = document.getElementById('OscillationResponseVI-input-2').value;
                stepResponse = dataObject.OscillationResponseVI[0];
                break;

            case 6://比例积分
                dataObject.ProportionalIntegralResponseVI[0].k1 = document.getElementById('ProportionalIntegralResponseVI-input-1').value;
                dataObject.ProportionalIntegralResponseVI[0].k2 = document.getElementById('ProportionalIntegralResponseVI-input-2').value;
                stepResponse = dataObject.ProportionalIntegralResponseVI[0];
                break;

            case 7://比例微分
                dataObject.ProportionalDifferentialResponseVI[0].k1 = document.getElementById('ProportionalDifferentialResponseVI-input-1').value;
                dataObject.ProportionalDifferentialResponseVI[0].k3 = document.getElementById('ProportionalDifferentialResponseVI-input-2').value;
                stepResponse = dataObject.ProportionalDifferentialResponseVI[0];
                break;

            case 8://比例惯性
                dataObject.ProportionalInertiaResponseVI[0].k1 = document.getElementById('ProportionalInertiaResponseVI-input-1').value;
                dataObject.ProportionalInertiaResponseVI[0].k2 = document.getElementById('ProportionalInertiaResponseVI-input-2').value;
                stepResponse = dataObject.ProportionalInertiaResponseVI[0];
                break;
        }

        if (stepResponse.source[0] && stepResponse.target[0]) {

            window.setInterval(onStepTimer, 50);
        }
        else {
            G.alert('未正确连接！', 1, 1000);
        }
    }

    function onStepTimer() {

        var i;
        stepResponse.source[0][0].setData(stepResponse.source[0][0].singleOutput);
        stepResponse.setData(stepResponse.source[0][0].singleOutput);

        if (stepResponse.target[0][0].name == 'WaveVI') {

            stepResponse.target[0][0].setData(stepResponse.output, 1024);//输出信号波形控件赋值
        }
        for (i = 0; i < stepResponse.source[0][0].target[0].length; i++) {

            if (stepResponse.source[0][0].target[i][0].name == 'WaveVI') {

                stepResponse.source[0][0].target[i][0].setData(stepResponse.source[0][0].output, 1024);//输入信号波形控件赋值
            }
        }
    }

    function setSignalType(type, elementNumber) {

        if (dataSetBox) {

            dataSetBox.close();
        }

        dataObject.SignalGeneratorVI[elementNumber].signalType = type;
        if (dataObject.SignalGeneratorVI[0].target[0]) {

            window.setInterval(onSignalTimer, 100);
        }
    }

    var amp = 1, frequency = 256, phase = 0;

    function onSignalTimer() {

        phase += 10;

        if (dataObject.SignalGeneratorVI[0].source) {

            for (var i = 0; i < dataObject.SignalGeneratorVI[0].source.length; i++) {

                if (dataObject.SignalGeneratorVI[0].source[i][1] == '1') {

                    amp = dataObject.SignalGeneratorVI[0].source[i][0].singleOutput;
                }
                else if (dataObject.SignalGeneratorVI[0].source[i][1] == '2') {

                    frequency = dataObject.SignalGeneratorVI[0].source[i][0].singleOutput;
                }
            }
        }

        dataObject.SignalGeneratorVI[0].setData(amp, frequency, phase);
        if (dataObject.SignalGeneratorVI[0].target[0][0].name == 'WaveVI') {

            dataObject.SignalGeneratorVI[0].target[0][0].setData(dataObject.SignalGeneratorVI[0].output, dataObject.SignalGeneratorVI[0].output.length);
        }

    }

    function allowDrop(e) {

        e.preventDefault();
    }

    function drag(e) {

        e.dataTransfer.setData('Text', e.target.id);
    }

    function drop(e) {

        e.preventDefault();
        var element = document.getElementById(e.dataTransfer.getData('Text'));
        var newElement = document.createElement('canvas');
        for (var i = 0; i < element.attributes.length - 3; i++) {
            newElement.setAttribute(element.attributes.item(i).nodeName, element.getAttribute(element.attributes.item(i).nodeName));
        }
        switch (element.id.split('-')[0]) {

            case 'BallBeamVI':
                if (dataObject.BallBeamVICount > 0) {
                    G.alert('球杆实验已添加！', 1, 1000);
                    return;
                }
                newElement.id = element.id + '-' + dataObject.BallBeamVICount++;
                break;
            case 'WaveVI':
                newElement.id = element.id + '-' + dataObject.WaveVICount++;
                break;

            case 'ADDVI':
                newElement.id = element.id + '-' + dataObject.ADDVICount++;
                break;

            case 'TextVI':
                newElement.id = element.id + '-' + dataObject.TextVICount++;
                break;

            case 'DCOutputVI':
                newElement.id = element.id + '-' + dataObject.DCOutputVICount++;
                break;

            case 'KnobVI':
                newElement.id = element.id + '-' + dataObject.KnobVICount++;
                break;

            case 'PIDVI':
                newElement.id = element.id + '-' + dataObject.PIDVICount++;
                break;

            case 'ProportionalResponseVI':
                if (dataObject.ProportionalResponseVICount > 0) {
                    G.alert('比例响应已存在！', 1, 1000);
                    return;
                }
                newElement.id = element.id + '-' + dataObject.ProportionalResponseVICount++;
                break;

            case 'IntegralResponseVI':
                if (dataObject.IntegralResponseVICount > 0) {
                    G.alert('积分响应已存在！', 1, 1000);
                    return;
                }
                newElement.id = element.id + '-' + dataObject.IntegralResponseVICount++;
                break;

            case 'DifferentialResponseVI':
                if (dataObject.DifferentialResponseVICount > 0) {
                    G.alert('微分响应已存在！', 1, 1000);
                    return;
                }
                newElement.id = element.id + '-' + dataObject.DifferentialResponseVICount++;
                break;

            case 'InertiaResponseVI':
                if (dataObject.InertiaResponseVICount > 0) {
                    G.alert('惯性响应已存在！', 1, 1000);
                    return;
                }
                newElement.id = element.id + '-' + dataObject.InertiaResponseVICount++;
                break;

            case 'OscillationResponseVI':
                if (dataObject.OscillationResponseVICount > 0) {
                    G.alert('震荡响应已存在！', 1, 1000);
                    return;
                }
                newElement.id = element.id + '-' + dataObject.OscillationResponseVICount++;
                break;

            case 'ProportionalIntegralResponseVI':
                if (dataObject.ProportionalIntegralResponseVICount > 0) {
                    G.alert('比例积分响应已存在！', 1, 1000);
                    return;
                }
                newElement.id = element.id + '-' + dataObject.ProportionalIntegralResponseVICount++;
                break;

            case 'ProportionalDifferentialResponseVI':
                if (dataObject.ProportionalDifferentialResponseVICount > 0) {
                    G.alert('比例微分响应已存在！', 1, 1000);
                    return;
                }
                newElement.id = element.id + '-' + dataObject.ProportionalDifferentialResponseVICount++;
                break;

            case 'ProportionalInertiaResponseVI':
                if (dataObject.ProportionalInertiaResponseVICount > 0) {
                    G.alert('比例惯性响应已存在！', 1, 1000);
                    return;
                }
                newElement.id = element.id + '-' + dataObject.ProportionalInertiaResponseVICount++;
                break;

            case 'SignalGeneratorVI':
                if (dataObject.SignalGeneratorVICount > 0) {
                    G.alert('信号发生器已存在！', 1, 1000);
                    return;
                }
                newElement.id = element.id + '-' + dataObject.SignalGeneratorVICount++;
                break;
        }
        newElement.setAttribute('oncontextmenu', 'toggleDrag(event, this)');
        newElement.width = element.width * element.getAttribute('zoom');
        newElement.height = element.height * element.getAttribute('zoom');
        newElement.style.left = (e.offsetX - newElement.width / 2) + 'px';
        newElement.style.top = (e.offsetY - newElement.height / 2) + 'px';
        VIDraw(newElement);
    }

    function VIDraw(element) {

        instance.getContainer().appendChild(element);
        instance.draggable(element);
        var elementInfo = element.id.split('-');
        switch (elementInfo[0]) {

            case 'BallBeamVI':
                dataObject.BallBeamVI.push(new BallBeamVI(element));
                addEndpoints(element.id, ['RightMiddle'], ['LeftMiddle'], -1, 1);

                var objCanvas = document.createElement('canvas');
                objCanvas.width = document.getElementById('container').clientWidth;
                objCanvas.height = 400;
                objCanvas.id = 'THREE-canvas';
                var hintSpan = document.createElement('p');
                hintSpan.setAttribute('class', 'normalSpan');
                hintSpan.id = 'hintSpan';
                hintSpan.innerHTML = '当前选定位置:0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;拖动滑块，选定小球预定位置开始实验';
                document.getElementById('mainVI').insertBefore(hintSpan, document.getElementById('container'));
                document.getElementById('mainVI').insertBefore(objCanvas, hintSpan);
                mainElement[3] = objCanvas;
                mainElement[4] = hintSpan;
                resize();
                dataObject.BallBeamVI[0].BallBeamDraw(objCanvas, loadingDiv);
                break;

            case 'WaveVI':
                dataObject.WaveVI.push(new WaveVI(element));
                addEndpoints(element.id, [], ['LeftMiddle'], 0, 1);
                break;

            case 'KnobVI':
                dataObject.KnobVI.push(new KnobVI(element));
                addEndpoints(element.id, ['TopCenter'], [], -1, 0);
                break;

            case 'DCOutputVI':
                dataObject.DCOutputVI.push(new DCOutputVI(element));
                addEndpoints(element.id, ['RightMiddle'], [], -1, 0);
                break;

            case 'PIDVI':
                dataObject.PIDVI.push(new PIDVI(element));
                addEndpoints(element.id, ['RightMiddle'], ['LeftMiddle'], -1, 1);
                break;

            case 'TextVI':
                dataObject.TextVI.push(new TextVI(element));

                dataObject.TextVI[dataObject.TextVICount - 1].setData(0);
                addEndpoints(element.id, [], ['LeftMiddle'], 0, 1);
                break;

            case 'ADDVI':
                dataObject.ADDVI.push(new AddVI(element));
                addEndpoints(element.id, ['RightMiddle'], ['LeftMiddle'], -1, 1);
                break;

            case 'ProportionalResponseVI':
                dataObject.ProportionalResponseVI.push(new ProportionalResponseVI(element));
                addEndpoints(element.id, ['RightMiddle'], ['LeftMiddle'], -1, 1);
                break;

            case 'IntegralResponseVI':
                dataObject.IntegralResponseVI.push(new IntegralResponseVI(element));
                addEndpoints(element.id, ['RightMiddle'], ['LeftMiddle'], -1, 1);
                break;

            case 'DifferentialResponseVI':
                dataObject.DifferentialResponseVI.push(new DifferentialResponseVI(element));
                addEndpoints(element.id, ['RightMiddle'], ['LeftMiddle'], -1, 1);
                break;

            case 'InertiaResponseVI':
                dataObject.InertiaResponseVI.push(new InertiaResponseVI(element));
                addEndpoints(element.id, ['RightMiddle'], ['LeftMiddle'], -1, 1);
                break;

            case 'OscillationResponseVI':
                dataObject.OscillationResponseVI.push(new OscillationResponseVI(element));
                addEndpoints(element.id, ['RightMiddle'], ['LeftMiddle'], -1, 1);
                break;

            case 'ProportionalIntegralResponseVI':
                dataObject.ProportionalIntegralResponseVI.push(new ProportionalIntegralResponseVI(element));
                addEndpoints(element.id, ['RightMiddle'], ['LeftMiddle'], -1, 1);
                break;

            case 'ProportionalDifferentialResponseVI':
                dataObject.ProportionalDifferentialResponseVI.push(new ProportionalDifferentialResponseVI(element));
                addEndpoints(element.id, ['RightMiddle'], ['LeftMiddle'], -1, 1);
                break;

            case 'ProportionalInertiaResponseVI':
                dataObject.ProportionalInertiaResponseVI.push(new ProportionalInertiaResponseVI(element));
                addEndpoints(element.id, ['RightMiddle'], ['LeftMiddle'], -1, 1);
                break;

            case 'SignalGeneratorVI':
                dataObject.SignalGeneratorVI.push(new SignalGeneratorVI(element));
                addEndpoints(element.id, ['RightMiddle'], ['LeftMiddle'], -1, 2);
                break;
        }
    }

    /**
     *添加节点
     * @param toId 元素ID
     * @param sourceAnchors 输出节点
     * @param targetAnchors 输入节点
     * @param sourcePointCount 输出节点允许最大连接数
     * @param targetPointCount 输入节点允许最大连接数
     */
    function addEndpoints(toId, sourceAnchors, targetAnchors, sourcePointCount, targetPointCount) {

        // this is the paint style for the connecting lines..
        var connectorPaintStyle = {
                    strokeWidth: 2,
                    stroke: '#61B7CF',
                    joinstyle: 'round',
                    outlineStroke: 'white',
                    outlineWidth: 2
                },
                // .. and this is the hover style.
                connectorHoverStyle = {
                    strokeWidth: 3,
                    stroke: '#216477',
                    outlineWidth: 5,
                    outlineStroke: 'white'
                },
                endpointHoverStyle = {
                    fill: '#216477',
                    stroke: '#216477'
                },
                // the definition of source endpoints (the small blue ones)
                sourceEndpoint = {
                    endpoint: 'Dot',
                    paintStyle: {
                        stroke: '#7AB02C',
                        fill: 'transparent',
                        radius: 7,
                        strokeWidth: 1
                    },
                    isSource: true,
                    maxConnections: sourcePointCount, //设置最大连接个数，-1为不限制
                    connector: ['Flowchart', {stub: [10, 15], gap: 10, cornerRadius: 5, alwaysRespectStubs: true}],
                    connectorStyle: connectorPaintStyle,
                    hoverPaintStyle: endpointHoverStyle,
                    connectorHoverStyle: connectorHoverStyle,
                    dragOptions: {},
                    overlays: [
                        ['Label', {
                            location: [0.5, 1.5],
                            label: 'Drag',
                            cssClass: 'endpointSourceLabel',
                            visible: false
                        }]
                    ]
                },
                // the definition of target endpoints (will appear when the user drags a connection)
                targetEndpoint = {
                    endpoint: 'Dot',
                    paintStyle: {fill: '#7AB02C', radius: 7},
                    hoverPaintStyle: endpointHoverStyle,
                    maxConnections: targetPointCount,
                    dropOptions: {hoverClass: 'hover', activeClass: 'active'},
                    isTarget: true,
                    overlays: [
                        ['Label', {
                            location: [0.5, -0.5],
                            label: 'Drop',
                            cssClass: 'endpointTargetLabel',
                            visible: false
                        }]
                    ]
                };

        for (var i = 0; i < sourceAnchors.length; i++) {

            var sourceUUID = toId + '-' + sourceAnchors[i];
            instance.addEndpoint(toId, sourceEndpoint, {anchor: sourceAnchors[i], uuid: sourceUUID});
        }
        for (var j = 0; j < targetAnchors.length; j++) {

            var targetUUID = toId + '-' + targetAnchors[j];
            instance.addEndpoint(toId, targetEndpoint, {anchor: targetAnchors[j], uuid: targetUUID});
        }
    }

    /**
     * 右键点击锁定VI
     * @param e
     * @param element
     */
    function toggleDrag(e, element) {

        e = e || window.event;
        e.preventDefault(); //阻止右键默认菜单
        instance.toggleDraggable(element);
    }

    window.addEventListener('resize', resize, false);

    function resize() {

        var height = document.documentElement.clientHeight * 0.95 > 600 ? document.documentElement.clientHeight * 0.95 : 600;
        mainElement[0].style.height = height + 'px';
        if (mainElement[3]) {

            mainElement[2].style.height = height + 'px';
            mainElement[1].style.height = height - mainElement[3].offsetHeight - mainElement[4].offsetHeight - 5 + 'px';
            mainElement[3].style.width = mainElement[1].clientWidth + 'px';
        }
        else {

            mainElement[1].style.height = height + 'px';
        }
    }
</script>
</body>
</html>